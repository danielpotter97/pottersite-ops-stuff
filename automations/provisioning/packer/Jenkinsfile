def path = "/home/automations/provisioning/packer" 

pipeline {
    agent any
   
    stages {
       stage('Git checkout') {
           steps{
               cleanWs()
               checkout scm 
               sh 'sudo cp -R ${WORKSPACE}/automations /home'
            }
        }

        stage('Validate packer file') {
            steps{
                withCredentials([string(credentialsId: 'ssh', variable: 'ssh_passwd')]){
                    sh '''packer validate \
                        -var-file='${path}/credentials.json' \
                        -var 'ssh_passwd=$params.ssh_passwd' \
                        ${path}/rocky-linux-8-docker/packer.json
            
                    '''
                }
            }
        }

        stage('Add ssh passwd to kikcstart'){
            steps{
                withCredentials([string(credentialsId: 'ssh', variable: 'ssh_passwd')]){
                    sh 'sudo sed -i "s/rootpw/rootpw $ssh_passwd/g" ${path}/rocky-linux-8-docker/inst.ks'
                    sh 'sudo sed -i "s/echo somepasswd | passwd --stdin potteradmin/echo $ssh_passwd | passwd --stdin potteradmin/g" ${path}/rocky-linux-8-docker/inst.ks'
                }
            }
        }

        stage('Build packer file') {
            steps{
                withCredentials([string(credentialsId: 'ssh', variable: 'ssh_passwd')]){  
                    sh '''packer build \
                         -var-file='${path}/credentials.json' \
                         -var 'ssh_passwd=$ssh_passwd' \
                         ${path}/rocky-linux-8-docker/packer.json
                    '''
                }
            }
        }


        stage('cleanup') {
            steps{
              sh "sudo rm -rf ${path}" 
            }
        }
    }

        
}