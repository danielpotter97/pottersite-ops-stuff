{
    "variables": {
      "proxmox_username": "",
      "token": "",
      "proxmox_url": "",
      "proxmox_node": "pve",
      "proxmox_storage_pool": "local-lvm",
      "proxmox_storage_pool_type": "lvm",
      "proxmox_storage_format": "qcow2",
      "proxmox_iso_pool": "local:iso",
      "centos_image": "Rocky-8.4-x86_64-minimal.iso",
      "template_name": "pottersite-template-01",
      "template_description": "Rocky Linux 8 Template",
      "version": "",
      "ssh_passwd": ""
    },
    "builders": [
      {
        "type": "proxmox",
        "username": "{{user `proxmox_username`}}",
        "token": "{{user `token`}}",
        "proxmox_url": "{{ user `proxmox_url`}}",
        "insecure_skip_tls_verify": true,
        "node": "{{user `proxmox_node`}}",
        "boot_command": [
          "<tab> text inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/inst.ks<enter><wait>"
        ],
        "network_adapters": [
          {
            "bridge": "vmbr0",
            "model": "virtio"
          }
        ],
        "disks": [
          {
            "type": "virtio",
            "disk_size": "30G",
            "storage_pool": "local-lvm",
            "storage_pool_type": "lvm",
            "format": "qcow2"
          }
        ],
        "scsi_controller": "virtio-scsi-pci",
        "iso_file": "{{user `proxmox_iso_pool`}}/{{user `centos_image`}}",
        "boot_wait": "10s",
        "cores": "1",
        "memory": "2048",
        "http_directory": "/home/automations/provisioning/packer/rocky-linux-8-docker",
        "http_bind_address": "192.168.0.21",
        "http_port_min": 8802,
        "http_port_max": 8802,
        "ssh_username": "root",
        "ssh_password": "{{user `ssh_passwd`}}",
        "ssh_port": 22,
        "ssh_timeout": "20m",
        "unmount_iso": false,
        "template_name": "{{user `template_name`}}",
        "template_description": "{{user `template_description`}}",
        "cloud_init": true,
        "cloud_init_storage_pool": "local-lvm"
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "inline": [
          "yum install -y cloud-init qemu-guest-agent cloud-utils-growpart gdisk",
          "shred -u /etc/ssh/*_key /etc/ssh/*_key.pub",
          "rm -f /var/run/utmp",
          ">/var/log/lastlog",
          ">/var/log/wtmp",
          ">/var/log/btmp",
          "rm -rf /tmp/* /var/tmp/*",
          "unset HISTFILE; rm -rf /home/*/.*history /root/.*history",
          "sudo dnf install -y yum-utils",
          "sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo",
          "sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin",
          "sudo systemctl enable --now docker",
          "dnf install -y epel-release",
          "dnf install -y ansible"
        ],
        "only": ["proxmox"]
      }
    ]

    
  }
