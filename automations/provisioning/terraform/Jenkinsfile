pipeline {
    agent any
    tools {
    terraform "terraform"
    }
    stages {
       stage('Git checkout') {
           steps{
               cleanWs()
               checkout scm
            }
        }
        stage('Add vmname to resource field') {
            steps{
                sh "sed -i 's/resource "proxmox_vm_qemu" ""/resource "proxmox_vm_qemu" "$params.vmname"/g' automations/provisioning/terraform/clone-vm.tf"
            }
        }
        stage('terraform format check') {
            steps{
                sh "PATH=/bin/terraform"
                sh 'cd automations/provisioning/terraform && terraform fmt'
            }
        }
        stage('terraform Init') {
            steps{
                sh 'cd automations/provisioning/terraform && terraform init'
            }
        }

        stage('terraform plan') {
            steps{
                dir ("automations/provisioning/terraform"){
                    sh """terraform plan \
                            -var-file='credentials.tfvars' \
                            -var 'vmid=$params.vmid' \
                            -var 'vmname=$params.vmname' \
                            -var 'cores=$params.cores' \
                            -var 'memory=$params.memory' \
                            -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                            -var 'desc=$params.desc' \
                            -no-color \
                            -out=plan.out
                    """
                }
            }
        }

        stage('terraform apply') {
            steps{
                dir ("automations/provisioning/terraform"){
                    sh """terraform apply \
                         -var-file='credentials.tfvars' \
                         -var 'vmid=$params.vmid' \
                         -var 'vmname=$params.vmname' \
                         -var 'cores=$params.cores' \
                         -var 'memory=$params.memory' \
                         -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                         -var 'desc=$params.desc' \
                         --auto-approve
                    """
                    sh "terraform output"
                }
            }
        }

        stage('Reboot VM') {
            steps {
                sshagent(credentials : ['pve']) {
                    sh "ssh root@192.168.0.20 qm reboot $params.vmid"
                }
            }
        }

        stage('cleanup') {
            steps{
              cleanWs()
            }
        }
    }

        
}