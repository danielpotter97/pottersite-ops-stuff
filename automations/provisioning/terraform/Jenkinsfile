def path = "/home/automations/provisioning/terraform" 

pipeline {
    agent any
    tools {
    terraform "terraform"
    }
    stages {
       stage('Git checkout') {
           steps{
               cleanWs()
               checkout scm
               sh 'sudo cp -R ${WORKSPACE}/automations /home'
            }
        }
        stage('Add vmname to resource field') {
            steps{
                sh """#!/bin/bash
                sudo sed -i 's/resource "proxmox_vm_qemu" ""/resource "proxmox_vm_qemu" "$params.vmname"/g' ${path}/clone-vm.tf
                """
                
            }
        }
        stage('terraform format check') {
            steps{
                sh "PATH=/bin/terraform"
                sh "cd ${path} && sudo terraform fmt"
            }
        }
        stage('terraform Init') {
            steps{
                sh "cd ${path} && sudo terraform init"
            }
        }

        stage('terraform plan') {
            steps{
                dir ("${path}"){
                    sh """sudo terraform plan \
                            -var-file='credentials.tfvars' \
                            -var 'vmid=$params.vmid' \
                            -var 'vmname=$params.vmname' \
                            -var 'cores=$params.cores' \
                            -var 'memory=$params.memory' \
                            -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                            -var 'desc=$params.desc' \
                            -no-color \
                            -out=plan.out
                    """
                }
            }
        }

        stage('terraform apply') {
            steps{
                dir ("${path}"){
                    sh """sudo terraform apply \
                         -var-file='credentials.tfvars' \
                         -var 'vmid=$params.vmid' \
                         -var 'vmname=$params.vmname' \
                         -var 'cores=$params.cores' \
                         -var 'memory=$params.memory' \
                         -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                         -var 'desc=$params.desc' \
                         --auto-approve
                    """
                    sh "terraform output"
                }
            }
        }

        stage('Reboot VM') {
            steps {
                sshagent(credentials : ['pve']) {
                    sh "ssh root@192.168.0.20 qm reboot $params.vmid"
                }
            }
        }

        stage('cleanup') {
            steps{
              sh "sudo rm -rf ${path}" 
            }
        }
    }

        
}