def path = "/automations/provisioning/terraform"

pipeline {
    agent any
    tools {
    terraform "terraform"
    }
    stages {
       stage('Git checkout') {
           steps{
               cleanWs()
               checkout scm
            }
        }
        stage('Add vmname to resource field') {
            steps{
                dir("${WORKSPACE}/${path}"){
                    sh """#!/bin/bash
                    sudo sed -i 's/resource "proxmox_vm_qemu" ""/resource "proxmox_vm_qemu" "$params.vmname"/g' clone-vm.tf
                    """
                }
            }
        }
        stage('terraform format check') {
            steps{
                dir("${WORKSPACE}/${path}"){
                    sh "PATH=/bin/terraform"
                    sh "sudo terraform fmt"
                }
            }
        }
        stage('terraform Init') {
            steps{
                dir("${WORKSPACE}/${path}"){
                    sh "sudo terraform init"
                }
            }
        }

        stage('terraform plan') {
            steps{
                dir("${WORKSPACE}/${path}"){
                    sh """terraform plan \
                            -var-file='credentials.tfvars' \
                            -var 'vmid=$params.vmid' \
                            -var 'vmname=$params.vmname' \
                            -var 'cores=$params.cores' \
                            -var 'memory=$params.memory' \
                            -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                            -var 'desc=$params.desc' \
                            -no-color \
                            -out=plan.out \
                            clone-vm.tf
                    """
                }
            }
        }

        stage('terraform apply') {
            steps{
                 dir("${WORKSPACE}/${path}"){
                    sh """terraform apply \
                         -var-file='credentials.tfvars' \
                         -var 'vmid=$params.vmid' \
                         -var 'vmname=$params.vmname' \
                         -var 'cores=$params.cores' \
                         -var 'memory=$params.memory' \
                         -var 'ip=ip=$params.ip/24,gw=192.168.0.1' \
                         -var 'desc=$params.desc' \
                         --auto-approve \
                         clone-vm.tf
                    """
                    sh "terraform output"
                }
            }
        }

        stage('Reboot VM') {
            steps {
                sshagent(credentials : ['pve']) {
                    sh "ssh root@192.168.0.20 qm reboot $params.vmid"
                }
            }
        }

    }

        
}